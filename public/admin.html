<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Panel - Jamestech</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="assets/style.css" rel="stylesheet" />
</head>
<body>
  <div class="navbar">
    <h1>üåê Jamestech</h1>
    <div class="nav-links">
      <a href="index.html">Home</a>
      <a href="register.html">Register</a>
      <a href="inbox.html">Inbox</a>
      <a href="admin.html">Admin</a>
    </div>
    <div id="clock"></div>
  </div>

  <div class="form-container">
    <h2>üîê Admin Panel</h2>

    <div id="loginBox">
      <input type="password" id="adminKey" placeholder="Enter Admin Key" />
      <button class="btn" onclick="loginAdmin()">Login</button>
    </div>

    <div id="adminPanel" style="display:none;">
      <p>Total OTP Records: <span id="otpCount">0</span></p>
      <button class="btn" onclick="clearOtps()">Clear All OTPs</button>

      <h3>All OTP Logs</h3>
      <ul id="otpList"></ul>
    </div>
  </div>

  <script>
    function updateClock() {
      const nairobiTime = new Date().toLocaleString("en-KE", { timeZone: "Africa/Nairobi" });
      document.getElementById("clock").innerText = "üïí Nairobi Time: " + nairobiTime;
    }
    setInterval(updateClock, 1000);
    updateClock();

    async function loginAdmin() {
      const key = document.getElementById("adminKey").value;
      const res = await fetch("/api/admin-login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ key })
      });
      const data = await res.json();
      if (data.success) {
        document.getElementById("loginBox").style.display = "none";
        document.getElementById("adminPanel").style.display = "block";
        loadOtps();
      } else {
        alert("Invalid admin key.");
      }
    }

    async function loadOtps() {
      const res = await fetch('/api/inbox');
      const data = await res.json();
      document.getElementById('otpCount').innerText = data.length;
      const list = document.getElementById('otpList');
      list.innerHTML = data.map((d, i) =>
        `<li>${d.number} - ${d.otp} (${new Date(d.timestamp).toLocaleString()})
         <button onclick="deleteOtp(${i})" style="margin-left:10px;">‚ùå</button></li>`).join('');
    }

    async function deleteOtp(index) {
      await fetch(`/api/delete-otp/${index}`, { method: 'DELETE' });
      loadOtps();
    }

    async function clearOtps() {
      await fetch("/api/delete-all", { method: 'DELETE' });
      loadOtps();
    }
  </script>
</body>
</html>